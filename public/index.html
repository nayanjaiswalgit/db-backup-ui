<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Postgres Backup UI</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="layout">
      <header class="hero">
        <div>
          <h1>üêò Postgres Backup & Restore</h1>
          <p>Manage backups for Docker containers and remote servers.</p>
        </div>
        <div style="display: flex; gap: 12px;">
          <button id="add-remote-btn" class="ghost-btn">üåê Add Remote Server</button>
          <button id="add-k3s-btn" class="ghost-btn">‚ò∏Ô∏è Add K3s Server</button>
          <button id="add-remote-k3s-btn" class="ghost-btn">üîó Add Remote K3s</button>
          <button id="refresh-btn" class="ghost-btn" aria-label="Refresh backups">‚ü≥ Refresh</button>
        </div>
      </header>

      <div class="tabs">
        <button class="tab-btn active" data-tab="local">üê≥ Local Docker</button>
        <button class="tab-btn" data-tab="remote">üåê Remote Servers</button>
        <button class="tab-btn" data-tab="k3s">‚ò∏Ô∏è K3s/Kubernetes</button>
      </div>

      <section class="card tab-content" id="local-tab" aria-labelledby="container-heading">
        <div class="card-header">
          <h2 id="container-heading">Postgres Containers</h2>
          <span id="container-status" class="badge badge-warning">Checking...</span>
        </div>
        <div class="card-body">
          <p class="status-line">
            <span class="label">Active:</span>
            <span id="container-name">Detecting...</span>
          </p>
          <p id="container-message" class="muted">
            We will auto-detect any running Postgres containers.
          </p>

          <div id="docker-help-section" class="hidden">
            <div class="help-box">
              <h3>üê≥ Docker Not Available</h3>
              <p>Docker Desktop is required to use this application. Please:</p>
              <ol>
                <li>Install <a href="https://www.docker.com/products/docker-desktop" target="_blank" rel="noopener">Docker Desktop</a> if not installed</li>
                <li>Start Docker Desktop application</li>
                <li>Wait for Docker to fully start (icon turns green)</li>
                <li>Click "Re-detect" button below</li>
              </ol>
              <p class="muted" style="margin-top: 12px;">
                <strong>Windows users:</strong> Ensure WSL 2 is installed and Docker Desktop is using WSL 2 backend.
              </p>
            </div>
          </div>

          <div id="container-list-section" class="hidden">
            <h3 style="font-size: 0.9rem; font-weight: 600; margin-top: 16px; margin-bottom: 8px;">Available Containers</h3>
            <ul id="container-list" class="container-list"></ul>
          </div>

          <div class="actions-row">
            <button id="detect-btn" class="ghost-btn">üîç Re-detect</button>
          </div>
          <p class="muted" style="margin-top: 12px; font-size: 0.85rem;">
            üí° Tip: Use the three-dot menu (‚ãÆ) on any backup to deploy it to a new container
          </p>
        </div>
      </section>

      <section class="card tab-content hidden" id="remote-tab">
        <div class="card-header">
          <h2>Remote Servers</h2>
        </div>
        <div class="card-body">
          <ul id="remote-server-list" class="container-list"></ul>
          <div id="remote-empty" class="muted" style="text-align: center; padding: 32px;">
            No remote servers configured. Click "Add Remote Server" to get started.
          </div>
        </div>
      </section>

      <section class="card tab-content hidden" id="k3s-tab">
        <div class="card-header">
          <h2>K3s/Kubernetes Clusters</h2>
          <span id="k3s-status" class="badge badge-warning">Checking...</span>
        </div>
        <div class="card-body">
          <div style="margin-bottom: 24px; padding-bottom: 24px; border-bottom: 1px solid var(--border);">
            <h3 style="font-size: 0.95rem; font-weight: 600; margin-bottom: 12px;">Remote K3s Clusters (via SSH)</h3>
            <ul id="remote-k3s-clusters-list" class="container-list"></ul>
            <div id="remote-k3s-empty" class="muted" style="text-align: center; padding: 32px;">
              No remote K3s clusters configured. Click "üîó Add Remote K3s" to connect to a remote K3s server.
            </div>
          </div>

          <div id="k3s-unavailable-section" class="hidden">
            <div class="help-box">
              <h3>‚ò∏Ô∏è kubectl Not Available</h3>
              <p>kubectl is required to access local Kubernetes/K3s clusters. For remote K3s clusters, use the "üîó Add Remote K3s" button instead.</p>
              <ol>
                <li>Install <a href="https://kubernetes.io/docs/tasks/tools/" target="_blank" rel="noopener">kubectl</a></li>
                <li>Configure your kubeconfig file (~/.kube/config)</li>
                <li>Verify access: <code>kubectl cluster-info</code></li>
                <li>Click "Re-check" button below</li>
              </ol>
            </div>
          </div>

          <div id="k3s-available-section" class="hidden">
            <div class="form-field">
              <label for="namespace-select">Namespace</label>
              <select id="namespace-select" aria-label="Kubernetes namespace">
                <option value="">Select namespace...</option>
              </select>
            </div>

            <div class="actions-row" style="margin-top: 12px;">
              <button id="discover-k3s-btn" class="primary-btn" disabled>üîç Discover PostgreSQL</button>
              <button id="k3s-recheck-btn" class="ghost-btn">‚ü≥ Re-check</button>
            </div>

            <div id="discovered-postgres-section" class="hidden" style="margin-top: 24px;">
              <h3 style="font-size: 0.95rem; font-weight: 600; margin-bottom: 12px;">Discovered PostgreSQL Resources</h3>

              <div id="discovered-pods-container">
                <h4 style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 8px;">Pods</h4>
                <ul id="discovered-pods-list" class="container-list"></ul>
                <p id="no-pods-message" class="muted hidden" style="font-size: 0.85rem; padding: 12px;">No PostgreSQL pods found in this namespace.</p>
              </div>

              <div id="discovered-services-container" style="margin-top: 16px;">
                <h4 style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 8px;">Services</h4>
                <ul id="discovered-services-list" class="container-list"></ul>
                <p id="no-services-message" class="muted hidden" style="font-size: 0.85rem; padding: 12px;">No PostgreSQL services found in this namespace.</p>
              </div>
            </div>

            <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border);">
              <h3 style="font-size: 0.95rem; font-weight: 600; margin-bottom: 12px;">Configured K3s Servers</h3>
              <ul id="k3s-server-list" class="container-list"></ul>
              <div id="k3s-empty" class="muted" style="text-align: center; padding: 32px;">
                No K3s servers configured. Discover PostgreSQL pods above to add them.
              </div>
            </div>
          </div>
        </div>
      </section>

      <section class="card tab-content" id="backups-card" aria-labelledby="backups-heading">
        <div class="card-header">
          <h2 id="backups-heading">Backups</h2>
          <span id="backup-summary" class="muted">Loading...</span>
        </div>

        <div class="backup-controls">
          <select id="database-select" aria-label="Database to back up from"></select>
          <button id="backup-btn" class="primary-btn">üì¶ Take Backup</button>
          <button id="cleanup-btn" class="ghost-btn">üßπ Cleanup Old</button>
        </div>

        <p id="backup-selection-info" class="muted"></p>

        <ul id="backups" class="backup-list" aria-live="polite"></ul>
      </section>
    </div>

    <!-- Remote Server Modal -->
    <div id="remote-modal" class="modal hidden">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Add Remote Server (SSH)</h2>
          <button class="modal-close" id="modal-close-btn">√ó</button>
        </div>
        <form id="remote-server-form">
          <div class="form-field">
            <label for="server-name">Server Name *</label>
            <input type="text" id="server-name" name="name" placeholder="Production DB" required />
          </div>
          <div class="form-field">
            <label for="server-host">Host *</label>
            <input type="text" id="server-host" name="host" placeholder="192.168.1.100" required />
          </div>
          <div class="form-field">
            <label for="server-username">SSH Username *</label>
            <input type="text" id="server-username" name="username" placeholder="root" required />
          </div>
          <div class="form-field">
            <label for="server-password">SSH Password</label>
            <input type="password" id="server-password" name="password" placeholder="(optional if using SSH key)" />
          </div>
          <div class="form-field">
            <label for="server-port">SSH Port</label>
            <input type="number" id="server-port" name="port" placeholder="22" value="22" />
          </div>
          <div class="form-field">
            <label for="server-pgport">PostgreSQL Port</label>
            <input type="number" id="server-pgport" name="pgPort" placeholder="5432" value="5432" />
          </div>
          <div class="form-field">
            <label for="server-database">Default Database</label>
            <input type="text" id="server-database" name="database" placeholder="postgres" value="postgres" />
          </div>
          <div class="modal-actions">
            <button type="button" class="ghost-btn" id="modal-cancel-btn">Cancel</button>
            <button type="submit" class="primary-btn">Add Server</button>
          </div>
        </form>
      </div>
    </div>

    <!-- K3s Server Modal (Local) -->
    <div id="k3s-modal" class="modal hidden">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Add K3s Server (Local)</h2>
          <button class="modal-close" id="k3s-modal-close-btn">√ó</button>
        </div>
        <form id="k3s-server-form">
          <div class="form-field">
            <label for="k3s-server-name">Server Name *</label>
            <input type="text" id="k3s-server-name" name="name" placeholder="Production K3s" required />
          </div>
          <div class="form-field">
            <label for="k3s-namespace">Namespace *</label>
            <input type="text" id="k3s-namespace" name="namespace" placeholder="default" required />
          </div>
          <div class="form-field">
            <label for="k3s-pod-name">Pod Name *</label>
            <input type="text" id="k3s-pod-name" name="podName" placeholder="postgres-0" required />
          </div>
          <div class="form-field">
            <label for="k3s-container-name">Container Name</label>
            <input type="text" id="k3s-container-name" name="containerName" placeholder="(optional, auto-detect)" />
          </div>
          <div class="form-field">
            <label for="k3s-password">PostgreSQL Password</label>
            <input type="password" id="k3s-password" name="password" placeholder="(optional)" />
          </div>
          <p class="muted" style="font-size: 0.85rem; margin-top: -8px;">
            üí° Tip: Use the K3s tab to discover PostgreSQL pods automatically
          </p>
          <div class="modal-actions">
            <button type="button" class="ghost-btn" id="k3s-modal-cancel-btn">Cancel</button>
            <button type="submit" class="primary-btn">Add K3s Server</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Remote K3s Cluster Modal -->
    <div id="remote-k3s-modal" class="modal hidden">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Add Remote K3s Cluster</h2>
          <button class="modal-close" id="remote-k3s-modal-close-btn">√ó</button>
        </div>
        <form id="remote-k3s-form">
          <div class="form-field">
            <label for="remote-k3s-name">Cluster Name *</label>
            <input type="text" id="remote-k3s-name" name="name" placeholder="Production K3s Cluster" required />
          </div>
          <div class="form-field">
            <label for="remote-k3s-host">Server Host/IP *</label>
            <input type="text" id="remote-k3s-host" name="host" placeholder="192.168.1.100" required />
          </div>
          <div class="form-field">
            <label for="remote-k3s-username">SSH Username *</label>
            <input type="text" id="remote-k3s-username" name="username" placeholder="root" required />
          </div>
          <div class="form-field">
            <label for="remote-k3s-password">SSH Password *</label>
            <input type="password" id="remote-k3s-password" name="password" placeholder="SSH password" required />
          </div>
          <div class="form-field">
            <label for="remote-k3s-ssh-port">SSH Port</label>
            <input type="number" id="remote-k3s-ssh-port" name="port" placeholder="22" value="22" />
          </div>
          <div class="form-field">
            <label for="remote-k3s-api-port">K3s API Port</label>
            <input type="number" id="remote-k3s-api-port" name="k3sPort" placeholder="6443" value="6443" />
          </div>
          <div class="form-field">
            <label for="remote-k3s-config-path">K3s Config Path</label>
            <input type="text" id="remote-k3s-config-path" name="k3sConfigPath" placeholder="/etc/rancher/k3s/k3s.yaml" value="/etc/rancher/k3s/k3s.yaml" />
          </div>
          <p class="muted" style="font-size: 0.85rem;">
            üí° The kubeconfig will be fetched automatically from the remote server via SSH
          </p>
          <div class="modal-actions">
            <button type="button" class="ghost-btn" id="remote-k3s-modal-cancel-btn">Cancel</button>
            <button type="submit" class="primary-btn">Add Cluster</button>
          </div>
        </form>
      </div>
    </div>

    <div id="toast" class="toast hidden" role="status" aria-live="polite">
      <span id="toast-message"></span>
    </div>

    <script src="script.js" type="module"></script>
  </body>
</html>
